services:
  # ==================== DATABASES ====================
  postgres-auth:
    image: postgres:15-alpine
    container_name: qhitz-postgres-auth
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: qhitz_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpass123}
    ports:
      - "5432:5432"
    volumes:
      - postgres-auth-data:/var/lib/postgresql/data
    networks:
      - qhitz-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U qhitz_user -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  postgres-media:
    image: postgres:15-alpine
    container_name: qhitz-postgres-media
    environment:
      POSTGRES_DB: media_db
      POSTGRES_USER: qhitz_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpass123}
    ports:
      - "5433:5432"
    volumes:
      - postgres-media-data:/var/lib/postgresql/data
    networks:
      - qhitz-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U qhitz_user -d media_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  postgres-cloud:
    image: postgres:15-alpine
    container_name: qhitz-postgres-cloud
    environment:
      POSTGRES_DB: cloud_db
      POSTGRES_USER: qhitz_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpass123}
    ports:
      - "5434:5432"
    volumes:
      - postgres-cloud-data:/var/lib/postgresql/data
    networks:
      - qhitz-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U qhitz_user -d cloud_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  postgres-property:
    image: postgres:15-alpine
    container_name: qhitz-postgres-property
    environment:
      POSTGRES_DB: property_db
      POSTGRES_USER: property_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-propertypass123}
    ports:
      - "5450:5432"
    volumes:
      - postgres-property-data:/var/lib/postgresql/data
    networks:
      - qhitz-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U property_user -d property_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  postgres-supply:
    image: postgres:15-alpine
    container_name: qhitz-postgres-supply
    environment:
      POSTGRES_DB: supply_chain_db
      POSTGRES_USER: supply_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-supplypass123}
    ports:
      - "5470:5432"
    volumes:
      - postgres-supply-data:/var/lib/postgresql/data
    networks:
      - qhitz-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U supply_user -d supply_chain_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ==================== CORE APIS ====================
  backend-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: qhitz-backend-api
    ports:
      - "0.0.0.0:5010:5010"
    volumes:
      - ./backend:/app:z
    environment:
      - DATABASE_URL=postgresql://qhitz_user:${POSTGRES_PASSWORD:-devpass123}@postgres-auth:5432/auth_db
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key}
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
    depends_on:
      postgres-auth:
        condition: service_healthy
    command: gunicorn -w 2 -b 0.0.0.0:5010 app:app
    networks:
      - qhitz-network
    restart: unless-stopped

  backend-media:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: qhitz-backend-media
    ports:
      - "0.0.0.0:5011:5011"
    volumes:
      - ./backend:/app:z
      - media-uploads:/app/uploads
    environment:
      - MEDIA_DATABASE_URL=postgresql://qhitz_user:${POSTGRES_PASSWORD:-devpass123}@postgres-media:5432/media_db
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key}
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
    depends_on:
      postgres-media:
        condition: service_healthy
    command: gunicorn -w 2 -b 0.0.0.0:5011 media_server:app
    networks:
      - qhitz-network
    restart: unless-stopped

  backend-cloud:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: qhitz-backend-cloud
    ports:
      - "0.0.0.0:5012:5012"
    volumes:
      - ./backend:/app:z
      - cloud-storage:/app/storage
    environment:
      - CLOUD_DATABASE_URL=postgresql://qhitz_user:${POSTGRES_PASSWORD:-devpass123}@postgres-cloud:5432/cloud_db
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key}
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
    depends_on:
      postgres-cloud:
        condition: service_healthy
    command: gunicorn -w 2 -b 0.0.0.0:5012 cloud_server:app
    networks:
      - qhitz-network
    restart: unless-stopped

  # ==================== PROPERTY MANAGEMENT ====================
  backend-property:
    build:
      context: ./property-management/backend
      dockerfile: Dockerfile
    container_name: qhitz-backend-property
    ports:
      - "0.0.0.0:5050:5050"
    volumes:
      - ./property-management/backend:/app:z
    environment:
      - DATABASE_URL=postgresql://property_user:${POSTGRES_PASSWORD:-propertypass123}@postgres-property:5432/property_db
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key}
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
    depends_on:
      postgres-property:
        condition: service_healthy
    command: gunicorn -w 2 -b 0.0.0.0:5050 app:app
    networks:
      - qhitz-network
    restart: unless-stopped

  # ==================== SUPPLY CHAIN ====================
  backend-supply:
    build:
      context: ./supply-chain/backend
      dockerfile: Dockerfile
    container_name: qhitz-backend-supply
    ports:
      - "0.0.0.0:5070:5070"
    volumes:
      - ./supply-chain/backend:/app:z
    environment:
      - DATABASE_URL=postgresql://supply_user:${POSTGRES_PASSWORD:-supplypass123}@postgres-supply:5432/supply_chain_db
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key}
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
    depends_on:
      postgres-supply:
        condition: service_healthy
    command: gunicorn -w 2 -b 0.0.0.0:5070 app:app
    networks:
      - qhitz-network
    restart: unless-stopped

  # ==================== FRONTEND & PROXY ====================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: qhitz-frontend
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_AUTH_API_URL=http://localhost:5010/api
      - REACT_APP_MEDIA_API_URL=http://localhost:5011/api
      - REACT_APP_CLOUD_API_URL=http://localhost:5012/api
      - REACT_APP_DENTAL_API_URL=http://localhost:5013/api
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - qhitz-network
    restart: unless-stopped

  reverse-proxy:
    image: nginx:stable-alpine
    container_name: qhitz-reverse-proxy
    ports:
      - "0.0.0.0:80:80"
    volumes:
      - ./reverse-proxy/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./frontend/build:/usr/share/nginx/html:ro
    depends_on:
      - frontend
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - qhitz-network

networks:
  qhitz-network:
    driver: bridge

volumes:
  postgres-auth-data:
    name: qhitz-postgres-auth-data
  postgres-media-data:
    name: qhitz-postgres-media-data
  postgres-cloud-data:
    name: qhitz-postgres-cloud-data
  postgres-property-data:
    name: qhitz-postgres-property-data
  postgres-supply-data:
    name: qhitz-postgres-supply-data
  media-uploads:
    name: qhitz-media-uploads
  cloud-storage:
    name: qhitz-cloud-storage
